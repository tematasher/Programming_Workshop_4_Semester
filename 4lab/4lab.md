
# Лабораторная работа №4: Расширение функциональности, тестирование и контейнеризация

## Введение

В данной лабораторной работе вам предстоит расширить функциональность ваших проектов, разработанных в предыдущих лабораторных работах. Основная цель - добавить новые функциональные возможности путем расширения структуры базы данных, разработать комплексную систему тестирования и настроить развертывание проекта с использованием Docker и Docker Compose.

## Общие требования

1. Расширить структуру базы данных, добавив новые таблицы
2. Реализовать методы для работы с новыми таблицами
3. Написать модульные (unit) тесты для API и Celery-задач
4. Настроить Docker Compose для запуска всех компонентов системы
5. Обеспечить корректную работу приложения как в Docker-контейнере, так и вне его (с использованием redislite)

## Расширение структуры базы данных

### 1. Обязательные таблицы (для всех вариантов)

#### 1.1. Таблица TaskResults

| Поле | Тип | Описание |
| :-- | :-- | :-- |
| id | Integer | Первичный ключ |
| task_id | String | Уникальный идентификатор задачи |
| user_id | Integer | Внешний ключ (users.id) |
| status | String | PENDING, STARTED, PROGRESS, SUCCESS, FAILURE |
| result | JSON | Результат выполнения задачи |
| created_at | DateTime | Время создания записи |
| updated_at | DateTime | Время обновления записи |

#### 1.2. Таблица UserActivity

| Поле | Тип | Описание |
| :-- | :-- | :-- |
| id | Integer | Первичный ключ |
| user_id | Integer | Внешний ключ (users.id) |
| action_type | String | LOGIN, API_CALL, TASK_SUBMIT, etc. |
| endpoint | String | Адрес API-эндпоинта |
| request_data | JSON | Данные запроса |
| ip_address | String | IP-адрес пользователя |
| created_at | DateTime | Время создания записи |

#### 1.3. Таблица ApiMetrics

| Поле | Тип | Описание |
| :-- | :-- | :-- |
| id | Integer | Первичный ключ |
| endpoint | String | Адрес API-эндпоинта |
| method | String | HTTP-метод |
| status_code | Integer | Код ответа |
| response_time | Float | Время ответа в миллисекундах |
| user_id | Integer | Внешний ключ (users.id) |
| created_at | DateTime | Время создания записи |

### 2. Специфические таблицы (в зависимости от варианта)

#### Вариант 1. Задача коммивояжёра

##### Таблица Graphs

| Поле | Тип | Описание |
| :-- | :-- | :-- |
| id | Integer | Первичный ключ |
| user_id | Integer | Внешний ключ (users.id) |
| name | String | Название графа |
| nodes | JSON | Узлы графа |
| edges | JSON | Рёбра графа [...] |
| created_at | DateTime | Время создания записи |

##### Таблица Paths

| Поле | Тип | Описание |
| :-- | :-- | :-- |
| id | Integer | Первичный ключ |
| graph_id | Integer | Внешний ключ (graphs.id) |
| user_id | Integer | Внешний ключ (users.id) |
| path | JSON | Найденный путь |
| total_distance | Float | Общая длина пути |
| algorithm | String | Использованный алгоритм |
| execution_time | Float | Время выполнения в секундах |
| created_at | DateTime | Время создания записи |

#### Вариант 2. Шифрование данных

##### Таблица EncryptionJobs

| Поле | Тип | Описание |
| :-- | :-- | :-- |
| id | Integer | Первичный ключ |
| user_id | Integer | Внешний ключ (users.id) |
| operation_type | String | ENCODE, DECODE |
| key | String | Ключ шифрования |
| huffman_codes | JSON | Коды Хаффмана |
| padding | Integer | Дополнение |
| execution_time | Float | Время выполнения в секундах |
| created_at | DateTime | Время создания записи |

#### Вариант 3. Нечеткий поиск

##### Таблица SearchCorpuses

| Поле | Тип | Описание |
| :-- | :-- | :-- |
| id | Integer | Первичный ключ |
| user_id | Integer | Внешний ключ (users.id) |
| name | String | Название корпуса |
| text | Text | Текст корпуса |
| word_count | Integer | Количество слов |
| created_at | DateTime | Время создания записи |

##### Таблица SearchResults

| Поле | Тип | Описание |
| :-- | :-- | :-- |
| id | Integer | Первичный ключ |
| corpus_id | Integer | Внешний ключ (search_corpuses.id) |
| user_id | Integer | Внешний ключ (users.id) |
| word | String | Искомое слово |
| algorithm | String | Использованный алгоритм |
| execution_time | Float | Время выполнения |
| results | JSON | Список найденных слов с расстояниями |
| created_at | DateTime | Время создания записи |

#### Вариант 4. Бинаризация изображений

##### Таблица ImageJobs

| Поле | Тип | Описание |
| :-- | :-- | :-- |
| id | Integer | Первичный ключ |
| user_id | Integer | Внешний ключ (users.id) |
| original_image_path | String | Путь к оригинальному изображению |
| binarized_image_path | String | Путь к бинаризованному изображению |
| algorithm | String | Алгоритм бинаризации |
| image_size | JSON | Размер изображения {"width": x, "height": y} |
| execution_time | Float | Время выполнения |
| created_at | DateTime | Время создания записи |

#### Вариант 5. Брутфорс

##### Таблица BruteforceJobs

| Поле | Тип | Описание |
| :-- | :-- | :-- |
| id | Integer | Первичный ключ |
| user_id | Integer | Внешний ключ (users.id) |
| hash_value | String | Хэш-значение |
| charset | String | Используемый набор символов |
| max_length | Integer | Максимальная длина пароля |
| result | String | Найденный пароль |
| combinations_checked | BigInteger | Количество проверенных комбинаций |
| combinations_per_second | Integer | Скорость перебора |
| elapsed_time | Float | Прошедшее время в секундах |
| created_at | DateTime | Время создания записи |
| updated_at | DateTime | Время обновления записи |

#### Вариант 6. Парсинг сайта и построение графа

##### Таблица ParseJobs

| Поле | Тип | Описание |
| :-- | :-- | :-- |
| id | Integer | Первичный ключ |
| user_id | Integer | Внешний ключ (users.id) |
| url | String | URL сайта |
| max_depth | Integer | Максимальная глубина парсинга |
| format | String | Формат вывода (graphml и др.) |
| total_pages | Integer | Общее количество страниц |
| total_links | Integer | Общее количество ссылок |
| result_path | String | Путь к файлу с результатом |
| elapsed_time | Float | Время выполнения в секундах |
| created_at | DateTime | Время создания записи |
| updated_at | DateTime | Время обновления записи |


## Разработка модульных тестов

Тесты должны быть совместимы с `pytest` и запускаться при вызове `pytest`.
Создайте директорию `tests/` в корне проекта и реализуйте следующие типы тестов:

### 1. Тесты для API-эндпоинтов

Создайте файл `tests/test_api.py` с тестами для всех ваших API-эндпоинтов. Используйте `TestClient` из FastAPI для тестирования HTTP-запросов.

### 2. Тесты для Celery-задач

Создайте файл `tests/test_tasks.py` для тестирования ваших Celery-задач.

## Настройка Docker и Docker Compose

### 1. Dockerfile

Создайте файл `Dockerfile` в корне проекта.

### 2. Docker Compose

Создайте файл `docker-compose.yml` в корне проекта.

### 3. Конфигурация для работы с redislite вне Docker

Создайте систему переключения между обычным Redis и redislite.

## Реализация задания по вариантам

### Вариант 1. Задача коммивояжёра

1. Реализуйте сохранение графов и результатов в базу данных.
2. Добавьте тесты для алгоритмов решения задачи коммивояжёра.
3. Обновите API для работы с сохраненными графами.

### Вариант 2. Шифрование данных

1. Реализуйте сохранение операций шифрования в базу данных.
2. Добавьте тесты для алгоритмов Хаффмана и XOR-шифрования.
3. Обновите API для работы с историей шифрования.

### Вариант 3. Нечеткий поиск

1. Реализуйте сохранение корпусов и результатов поиска в базу данных.
2. Добавьте тесты для алгоритмов нечеткого поиска.
3. Обновите API для работы с историей поисковых запросов.

### Вариант 4. Бинаризация изображений

1. Реализуйте сохранение операций бинаризации в базу данных.
2. Добавьте тесты для алгоритмов бинаризации.
3. Обновите API для работы с историей обработки изображений.

### Вариант 5. Брутфорс

1. Реализуйте сохранение заданий брутфорса в базу данных.
2. Добавьте тесты для алгоритма брутфорса.
3. Обновите API для работы с историей брутфорс-атак.

### Вариант 6. Парсинг сайта и построение графа

1. Реализуйте сохранение заданий парсинга в базу данных.
2. Добавьте тесты для алгоритма парсинга и построения графа.
3. Обновите API для работы с историей парсинга.

## Требования к сдаче работы

1. Репозиторий должен содержать файлы `Dockerfile` и `docker-compose.yml`.
2. Репозиторий должен содержать директорию `tests/` с модульными тестами.
3. Проект должен успешно запускаться как с использованием Docker Compose, так и без него.
4. Все API-эндпоинты должны быть протестированы и работать корректно.
5. Должны быть реализованы все новые таблицы и методы для работы с ними.



## Дополнительные материалы

- [Pytest документация](https://docs.pytest.org/en/stable/)
- [FastAPI Testing документация](https://fastapi.tiangolo.com/tutorial/testing/)
- [Celery Testing документация](https://docs.celeryproject.org/en/latest/userguide/testing.html)
- [Docker Compose документация](https://docs.docker.com/compose/)
- [Redislite документация](https://redislite.readthedocs.io/en/latest/)


